name: Warm Independent Project Caches

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      scope:
        description: 'What to warm: all, changed in latest commit, or newly added projects'
        required: false
        type: choice
        default: all
        options:
          - all
          - changed
          - new_projects
      shard_total:
        description: 'Number of shards (>=1)'
        required: false
        type: number
        default: 1
      shard_index:
        description: 'Shard index (0-based)'
        required: false
        type: number
        default: 0
      target:
        description: 'Project kind to warm'
        required: false
        type: choice
        default: all
        options:
          - all
          - books
          - papers
      strict:
        description: 'If true, fail workflow when any selected project fails'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  discover-projects:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.collect.outputs.projects }}
      project_count: ${{ steps.collect.outputs.project_count }}
      selected_slugs: ${{ steps.collect.outputs.selected_slugs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Select projects for this shard
        id: collect
        env:
          SCOPE: ${{ inputs.scope || 'all' }}
          SHARD_TOTAL: ${{ inputs.shard_total || 1 }}
          SHARD_INDEX: ${{ inputs.shard_index || 0 }}
          TARGET: ${{ inputs.target || 'all' }}
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os
          import subprocess
          from pathlib import Path

          scope = (os.environ.get("SCOPE") or "all").strip().lower()
          shard_total = max(1, int(os.environ.get("SHARD_TOTAL") or 1))
          shard_index = max(0, int(os.environ.get("SHARD_INDEX") or 0))
          target = (os.environ.get("TARGET") or "all").strip().lower()

          root = Path("ReasBook")
          all_projects = []
          for kind_title, kind_slug, kind_dir, leaf in [
              ("Books", "books", root / "Books", "Book"),
              ("Papers", "papers", root / "Papers", "Paper"),
          ]:
              if not kind_dir.is_dir():
                  continue
              if target != "all" and target != kind_slug:
                  continue
              for p in sorted(kind_dir.iterdir()):
                  if not p.is_dir() or not (p / "build.sh").is_file():
                      continue
                  all_projects.append(
                      {
                          "kind": kind_slug,
                          "kindTitle": kind_title,
                          "name": p.name,
                          "slug": p.name.lower(),
                          "path": str(p),
                          "pathPrefix": f"{kind_dir.as_posix()}/{p.name}/",
                          "docsModule": f"{kind_title}.{p.name}.{leaf}",
                      }
                  )

          def changed_entries() -> list[tuple[str, str]]:
              try:
                  out = subprocess.check_output(
                      ["git", "diff", "--name-status", "HEAD~1", "HEAD"],
                      text=True,
                  )
              except Exception:
                  return []
              entries = []
              for line in out.splitlines():
                  parts = line.split("\t", 1)
                  if len(parts) != 2:
                      continue
                  status, path = parts[0].strip(), parts[1].strip()
                  if path:
                      entries.append((status, path))
              return entries

          selected = all_projects
          if scope in {"changed", "new_projects"}:
              entries = changed_entries()
              slug_by_prefix = {p["slug"]: p["pathPrefix"] for p in all_projects}
              if scope == "changed":
                  slugs = {
                      slug
                      for slug, prefix in slug_by_prefix.items()
                      if any(path.startswith(prefix) for _, path in entries)
                  }
              else:
                  slugs = {
                      slug
                      for slug, prefix in slug_by_prefix.items()
                      if any(status.startswith("A") and path.startswith(prefix) for status, path in entries)
                  }
              selected = [p for p in all_projects if p["slug"] in slugs]

          selected = [p for i, p in enumerate(selected) if i % shard_total == shard_index]
          for p in selected:
              p.pop("pathPrefix", None)

          selected_slugs = ",".join(p["slug"] for p in selected)
          print(f"projects={json.dumps(selected, separators=(',', ':'))}")
          print(f"project_count={len(selected)}")
          print(f"selected_slugs={selected_slugs}")
          PY

      - name: Log selected projects
        run: |
          echo "Selected project count: ${{ steps.collect.outputs.project_count }}"
          echo "Selected project slugs: ${{ steps.collect.outputs.selected_slugs }}"

  warm-caches:
    needs: discover-projects
    if: ${{ needs.discover-projects.outputs.project_count != '0' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y

      - name: Restore per-project cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ matrix.project.path }}/.lake
          key: lake-proj-${{ runner.os }}-${{ runner.arch }}-${{ matrix.project.slug }}-${{ hashFiles(format('{0}/lean-toolchain', matrix.project.path)) }}-${{ hashFiles(format('{0}/lake-manifest.json', matrix.project.path)) }}
          restore-keys: |
            lake-proj-${{ runner.os }}-${{ runner.arch }}-${{ matrix.project.slug }}-

      - name: Warm project build cache
        id: warm
        continue-on-error: true
        run: |
          set -euo pipefail
          cd "${{ matrix.project.path }}"
          chmod +x ./build.sh
          ./build.sh

      - name: Save per-project cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ matrix.project.path }}/.lake
          key: lake-proj-${{ runner.os }}-${{ runner.arch }}-${{ matrix.project.slug }}-${{ hashFiles(format('{0}/lean-toolchain', matrix.project.path)) }}-${{ hashFiles(format('{0}/lake-manifest.json', matrix.project.path)) }}

      - name: Fail in strict mode when project build failed
        if: ${{ (inputs.strict || false) && steps.warm.outcome != 'success' }}
        run: |
          echo "Project cache warm failed in strict mode: ${{ matrix.project.slug }}"
          exit 1
