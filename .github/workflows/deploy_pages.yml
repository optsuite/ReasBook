name: Deploy Verso site to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain manager)
        run: curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y

      - name: Restore main project cache if available
        uses: actions/cache/restore@v4
        with:
          path: |
            ReasBook/.lake
          key: lake-main-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBook/lean-toolchain') }}-${{ hashFiles('ReasBook/lake-manifest.json') }}-${{ github.sha }}
          restore-keys: |
            lake-main-${{ runner.os }}-${{ runner.arch }}-

      - name: Restore ReasBookWeb project cache if available
        uses: actions/cache/restore@v4
        with:
          path: |
            ReasBookWeb/.lake
          key: lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBookWeb/lean-toolchain') }}-${{ hashFiles('ReasBookWeb/lake-manifest.json') }}-${{ github.sha }}
          restore-keys: |
            lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-

      - name: Force clean site output only
        run: |
          rm -rf ReasBookWeb/_site

      # mathlib cache
      - name: Get Mathlib cache (main project)
        run: |
          ~/.elan/bin/lake exe cache get || true
        working-directory: ReasBook

      # 生成主项目 API docs
      - name: Build main project docs (doc-gen4)
        run: |
          ~/.elan/bin/lake -R -Kenv=dev build ReasBook:docs
          for entry in Books/*/Book.lean Papers/*/Paper.lean; do
            [ -f "$entry" ] || continue
            mod="${entry%.lean}"
            mod="${mod//\//.}"
            ~/.elan/bin/lake -R -Kenv=dev build "$mod:docs"
          done
        working-directory: ReasBook

      - name: Build main project
        run: |
          ~/.elan/bin/lake build
        working-directory: ReasBook

      # ReasBookWeb 目录下有脚本生成 Sections/Routes 的话，记得先跑
      - name: Generate sections/routes
        run: |
          python3 scripts/gen_sections.py
        working-directory: ReasBookWeb

      - name: Build Verso site
        run: |
          ~/.elan/bin/lake exe reasbook-site
        working-directory: ReasBookWeb

      # Copy main project docs into site as /docs
      - name: Copy main docs into site as /docs
        run: |
          mkdir -p ReasBookWeb/_site/docs
          cp -r ReasBook/.lake/build/doc/. ReasBookWeb/_site/docs/
          find ReasBookWeb/_site/docs -name "*.trace" -delete || true
          find ReasBookWeb/_site/docs -name "*.hash" -delete || true
          if [ ! -f ReasBookWeb/_site/docs/index.html ]; then
            {
              echo '<!doctype html>'
              echo '<html lang="en">'
              echo '<head>'
              echo '  <meta charset="utf-8" />'
              echo '  <meta name="viewport" content="width=device-width, initial-scale=1" />'
              echo '  <title>ReasBook Documentation</title>'
              echo '</head>'
              echo '<body>'
              echo '  <h1>ReasBook Documentation</h1>'
              echo '  <ul>'
              echo '    <li><a href="./Books/Analysis2_Tao_2022/Chapters/Chap01/section01.html">Analysis II (Tao): Chapter 1 Section 1</a></li>'
              echo '    <li><a href="./Books/ConvexAnalysis_Rockafellar_1970/Chapters/Chap01/section01_part1.html">Convex Analysis (Rockafellar): Chapter 1 Section 1 Part 1</a></li>'
              echo '    <li><a href="./Books/IntroductiontoRealAnalysisVolumeI_JiriLebl_2025/Chapters/Chap01/section01.html">Introduction to Real Analysis I (Lebl): Chapter 1 Section 1</a></li>'
              echo '    <li><a href="./Papers/SmoothMinimization_Nesterov_2004/Sections/section01.html">Nesterov 2004: Section 1</a></li>'
              echo '    <li><a href="./Papers/OnSomeLocalRings_Maassaran_2025/Sections/section01.html">Maassarani 2025: Section 1</a></li>'
              echo '  </ul>'
              echo '</body>'
              echo '</html>'
            } > ReasBookWeb/_site/docs/index.html
          fi

      - name: Verify generated site tree
        run: |
          echo "Commit: $GITHUB_SHA"
          echo "Top-level _site entries:"
          ls -la ReasBookWeb/_site
          echo "Top-level _site/docs entries:"
          ls -la ReasBookWeb/_site/docs
          echo "Check site root injection in generated HTML:"
          grep -R --line-number "__versoSiteRoot" ReasBookWeb/_site | head -n 20
          echo "Check <base href> in generated HTML:"
          grep -R --line-number '<base href="/ReasBook/"/>' ReasBookWeb/_site | head -n 20
          echo "Check for known bad duplicated path pattern:"
          ! grep -R --line-number 'chap01/books/' ReasBookWeb/_site
          test -f ReasBookWeb/_site/index.html
          test -f ReasBookWeb/_site/docs/index.html

      - name: Save main project cache
        uses: actions/cache/save@v4
        with:
          path: |
            ReasBook/.lake
          key: lake-main-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBook/lean-toolchain') }}-${{ hashFiles('ReasBook/lake-manifest.json') }}-${{ github.sha }}

      - name: Save ReasBookWeb project cache
        uses: actions/cache/save@v4
        with:
          path: |
            ReasBookWeb/.lake
          key: lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBookWeb/lean-toolchain') }}-${{ hashFiles('ReasBookWeb/lake-manifest.json') }}-${{ github.sha }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ReasBookWeb/_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Print deployed Pages URL
        run: |
          echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
