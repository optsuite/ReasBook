name: Deploy Verso site to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan (Lean toolchain manager)
        run: curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y

      - name: Restore main project cache if available
        uses: actions/cache/restore@v4
        with:
          path: |
            ReasBook/.lake
          key: lake-main-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBook/lean-toolchain') }}-${{ hashFiles('ReasBook/lake-manifest.json') }}-${{ github.sha }}
          restore-keys: |
            lake-main-${{ runner.os }}-${{ runner.arch }}-

      - name: Restore ReasBookWeb project cache if available
        uses: actions/cache/restore@v4
        with:
          path: |
            ReasBookWeb/.lake
          key: lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBookWeb/lean-toolchain') }}-${{ hashFiles('ReasBookWeb/lake-manifest.json') }}-${{ github.sha }}
          restore-keys: |
            lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-

      # mathlib cache
      - name: Get Mathlib cache (main project)
        run: |
          ~/.elan/bin/lake exe cache get || true
        working-directory: ReasBook

      # 生成主项目 API docs
      - name: Build main project docs (doc-gen4)
        run: |
          ~/.elan/bin/lake -R -Kenv=dev build ReasBook:docs
        working-directory: ReasBook

      - name: Build main project
        run: |
          ~/.elan/bin/lake build
        working-directory: ReasBook

      # ReasBookWeb 目录下有脚本生成 Sections/Routes 的话，记得先跑
      - name: Generate sections/routes
        run: |
          python3 scripts/gen_sections.py
        working-directory: ReasBookWeb

      - name: Build Verso site
        run: |
          ~/.elan/bin/lake exe reasbook-site
        working-directory: ReasBookWeb

      # Copy main project docs into site as /docs
      - name: Copy main docs into site as /docs
        run: |
          mkdir -p ReasBookWeb/_site/docs
          cp -r ReasBook/.lake/build/doc/. ReasBookWeb/_site/docs/
          find ReasBookWeb/_site/docs -name "*.trace" -delete || true
          find ReasBookWeb/_site/docs -name "*.hash" -delete || true

      - name: Verify generated site tree
        run: |
          echo "Top-level _site entries:"
          ls -la ReasBookWeb/_site
          echo "Top-level _site/docs entries:"
          ls -la ReasBookWeb/_site/docs
          echo "Check site root injection in generated HTML:"
          grep -R --line-number "__versoSiteRoot" ReasBookWeb/_site | head -n 20
          test -f ReasBookWeb/_site/index.html
          test -f ReasBookWeb/_site/docs/index.html

      - name: Save main project cache
        uses: actions/cache/save@v4
        with:
          path: |
            ReasBook/.lake
          key: lake-main-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBook/lean-toolchain') }}-${{ hashFiles('ReasBook/lake-manifest.json') }}-${{ github.sha }}

      - name: Save ReasBookWeb project cache
        uses: actions/cache/save@v4
        with:
          path: |
            ReasBookWeb/.lake
          key: lake-ReasBookWeb-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('ReasBookWeb/lean-toolchain') }}-${{ hashFiles('ReasBookWeb/lake-manifest.json') }}-${{ github.sha }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ReasBookWeb/_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Print deployed Pages URL
        run: echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
